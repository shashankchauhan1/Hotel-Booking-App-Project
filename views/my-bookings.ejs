<%- include('partials/header', { user: user }) %>

<h2>My Bookings</h2>

<div class="bookings-list">
    <% if (bookings.length > 0) { %>
        <% bookings.forEach(booking => { %>
            <div class="card booking-card" id="booking-<%= booking._id %>">
                <div class="card-body">
                    <h3><%= booking.hotel.name %></h3>
                    <p><%= booking.hotel.location %></p>
                    <p><strong>Room:</strong> <%= booking.room.type %> - <%= booking.room.roomNumber %></p>
                    <p>
                        <strong>Dates:</strong> 
                        <%= new Date(booking.checkInDate).toLocaleDateString() %> to 
                        <%= new Date(booking.checkOutDate).toLocaleDateString() %>
                    </p>
                    <p><strong>Total Price:</strong> $<%= booking.totalPrice.toFixed(2) %></p>
                    <p><strong>Status:</strong> <span class="status-<%= booking.status %>"><%= booking.status %></span></p>

                    <% if (booking.status !== 'cancelled') { %>
                        <button onclick="cancelBooking('<%= booking._id %>')" class="btn btn-danger">Cancel Booking</button>
                    <% } %>
                </div>
            </div>
        <% }) %>
    <% } else { %>
        <p>You have no bookings yet. <a href="/hotels">Find a hotel to book!</a></p>
    <% } %>
</div>

<script>
    async function cancelBooking(bookingId) {
        if (confirm('Are you sure you want to cancel this booking?')) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Booking cancelled successfully!');
                    // Update the UI to show the cancelled status without a full reload
                    const bookingCard = document.getElementById(`booking-${bookingId}`);
                    const statusSpan = bookingCard.querySelector('.status-cancelled, .status-pending, .status-confirmed');
                    statusSpan.textContent = 'cancelled';
                    statusSpan.className = 'status-cancelled';
                    // Remove the cancel button
                    bookingCard.querySelector('button').remove();
                } else {
                    alert(`Error: ${data.message || 'Failed to cancel booking.'}`);
                }
            } catch (error) {
                console.error('Cancellation error:', error);
                alert('An error occurred during cancellation.');
            }
        }
    }
</script>

<%- include('partials/footer') %>
