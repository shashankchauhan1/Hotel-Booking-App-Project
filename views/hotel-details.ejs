<%- include('partials/header', { user: user }) %>

<div class="hotel-details-container">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h2><%= hotel.name %></h2>
            <p class="location"><%= hotel.location %></p>
            <div class="rating">
                <span>Rating: <%= hotel.rating.toFixed(1) %> / 5</span>
                <span>(<%= hotel.reviews.length %> reviews)</span>
            </div>
        </div>
        <% if (user && user.role === 'admin') { %>
            <a href="/admin/new-room/<%= hotel._id %>" class="btn">Add a Room</a>
        <% } %>
    </div>

    <div class="gallery">
        <% hotel.images.forEach(img => { %>
            <img src="<%= img %>" alt="<%= hotel.name %>">
        <% }) %>
    </div>

    <h3>About this hotel</h3>
    <p><%= hotel.description %></p>

    <hr>

    <h3>Available Rooms</h3>
    <div class="room-list">
        <% if (rooms.length > 0) { %>
            <% rooms.forEach(room => { %>
                <div class="room-item" style="border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                    <img src="<%= room.images.length ? room.images[0] : 'https://placehold.co/600x400/EEE/31343C?text=Room+Image' %>" alt="<%= room.type %> Room" style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                    <h4><%= room.type %> Room - <%= room.roomNumber %></h4>
                    <p>Price: $<%= room.price %> / night</p>
                    <% if (room.isAvailable) { %>
                        <a href="/booking/<%= hotel._id %>/<%= room._id %>" class="btn btn-primary">Book Now</a>
                    <% } else { %>
                        <button class="btn" disabled>Not Available</button>
                    <% } %>
                </div>
            <% }) %>
        <% } else { %>
            <p>No rooms have been added for this hotel yet.</p>
        <% } %>
    </div>
    
    <hr>

    <h3>Reviews</h3>
    <div class="reviews-section">
        <% if (user) { %>
            <div class="form-container" style="margin: 0 0 30px 0; padding: 20px;">
                <h4>Leave a Review</h4>
                <form id="reviewForm">
                    <div class="form-group">
                        <label for="rating">Rating (1-5)</label>
                        <input type="number" id="rating" name="rating" min="1" max="5" required>
                    </div>
                    <div class="form-group">
                        <label for="comment">Comment</label>
                        <textarea id="comment" name="comment" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn">Submit Review</button>
                </form>
                <p id="reviewError" style="color: red;"></p>
            </div>
        <% } %>

        <% if (hotel.reviews.length > 0) { %>
            <% hotel.reviews.forEach(review => { %>
                <div class="review" style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                    <strong>Rating: <%= review.rating %> / 5</strong>
                    <p><%= review.comment %></p>
                </div>
            <% }) %>
        <% } else { %>
            <p>No reviews yet. Be the first to leave one!</p>
        <% } %>
    </div>
</div>

<script>
    if (document.getElementById('reviewForm')) {
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const reviewError = document.getElementById('reviewError');
            reviewError.textContent = '';

            const reviewData = {
                rating: parseInt(form.rating.value),
                comment: form.comment.value
            };

            try {
                const response = await fetch(`/api/hotels/<%= hotel._id %>/reviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Review submitted successfully!');
                    window.location.reload();
                } else {
                    reviewError.textContent = data.message || 'Failed to submit review.';
                }
            } catch (error) {
                console.error('Error:', error);
                reviewError.textContent = 'An error occurred.';
            }
        });
    }
</script>

<%- include('partials/footer') %>


